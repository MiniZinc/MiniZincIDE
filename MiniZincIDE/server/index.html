<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>%3 | MiniZincIDE</title>
        <style>
            html, body {
                margin: 0;
                padding: 0;
                font-family: sans-serif;
            }
            * {
                box-sizing: border-box;
            }
            #windows {
                width: 100vw;
                height: 100vh;
                display: grid;
                grid-auto-rows: auto;
                gap: 1px;
                background: #CCC;
            }
            #windows > * {
                background: #FFF;
                border: 0;
                width: 100%;
                height: 100%;
            }
            #notice {
                width: 100vw;
                position: absolute;
                top: 20vw;
                left: 0;
                text-align: center;
            }
            #notice:empty {
                display: none;
            }
        </style>
    </head>
    <body>
        <div id="windows"></div>
        <div id="notice">Connecting...</div>
        <script>
            const layoutGrid = (container) => {
                const numChildren = container.children.length;
                const cols = Math.ceil(Math.sqrt(numChildren));
                container.style = `grid-template-columns: repeat(${cols}, auto);`;
            };
            const windows = document.getElementById('windows');
            const buffers = [];
            const ws = new WebSocket('%1/%2');
            const notice = document.getElementById('notice');
            
            const addWindow = (url, userData) => {
                const frame = document.createElement("iframe");
                const buffer = {
                    ready: false,
                    queue: [{event: 'init', payload: userData}]
                };
                frame.addEventListener('load', () => {
                    buffer.ready = true;
                });
                frame.src = `%2/${url}`;
                windows.appendChild(frame);
                buffers.push(buffer);
                layoutGrid(windows);
            }

            ws.onopen = () => {
                notice.textContent = '';
            };
            ws.onerror = e => {
                notice.textContent = `A WebSocket error occurred (code ${e.code}).`;
                console.log('WebSocket error: ', e);
            };
            ws.onclose = () => {
                notice.textContent = 'Disconnected. Refresh the page to try again.';
            };
            ws.onmessage = e => {
                const message = JSON.parse(e.data);
                switch (message.event) {
                    case 'navigate':
                        window.location = message.url;
                        break;
                    case 'init':
                        for (const w of message.windows) {
                            addWindow(w.url, w.userData);
                        }
                        break;
                    case 'window':
                        addWindow(message.url, message.userData);
                        break;
                    case 'response':
                        // Pass response to child
                        buffers[message.window].queue.push({
                            event: 'response',
                            id: message.id,
                            payload: message.payload
                        });
                        break;
                    case 'error':
                        // Pass error to child
                        buffers[message.window].queue.push({
                            event: 'error',
                            id: message.id,
                            message: message.message
                        });
                        break;
                    case 'solution':
                        // Pass solution to children
                        for (let i = 0; i < message.items.length; i++) {
                            buffers[i].queue.push({
                                event: 'solution',
                                payload: {
                                    time: message.time,
                                    data: message.items[i]
                                }
                            });
                        }
                        break;
                    case 'status':
                        // Pass on to all children
                        for (const buffer of buffers) {
                            buffer.queue.push({
                                status: message.status,
                                time: message.time
                            });
                        }
                        break;
                    case 'finish':
                        // Pass on to all children
                        for (const buffer of buffers) {
                            buffer.queue.push({
                                time: message.time
                            });
                        }
                        break;
                }
            };
            window.addEventListener('message', e => {
                const message = e.data;
                switch (message.event) {
                    case 'rebroadcast':
                        // Rebroadcast to all children
                        for (const buffer of buffers) {
                            buffer.queue.push(message.message);
                        }
                        break;
                    default:
                        // Pass on to IDE
                        let windowIndex = -1;
                        for (let i = 0; i < windows.children.length; i++) {
                            if (windows.children[i].contentWindow === e.source) {
                                windowIndex = i;
                            }
                        }
                        if (windowIndex === -1) {
                            console.error('Could not determine source window for message');
                            e.source.postMessage({
                                event: 'error',
                                id: message.id,
                                message: 'Could not determine source window'
                            });
                            return;
                        }
                        ws.send(JSON.stringify({
                            ...message,
                            window: windowIndex
                        }));
                        break;
                }
            });
            window.setInterval(() => {
                for (let i = 0; i < buffers.length; i++) {
                    if (buffers[i].ready) {
                        const frame = windows.children[i];
                        if (frame) {
                            for (const message of buffers[i].queue) {
                                frame.contentWindow.postMessage(message, '*');
                            }
                            buffers[i].queue = [];
                        }
                    }
                }
            }, 1);
        </script>
    </body>
</html>
